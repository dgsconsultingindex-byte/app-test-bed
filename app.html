<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PrioBox ‚Äî Priority Matrix</title>
  <meta name="description" content="PrioBox ‚Äî priority matrix, focus timer, and smart queue." />
  <style>
    /* ---------------- Design tokens (Linear-style) ---------------- */
    :root{
      --bg:#f8fafc;
      --surface:#ffffff;
      --surface-elev:#fbfcfd;
      --border:#e6e9ee;
      --text:#0b1220;
      --muted:#6b7280;
      --accent:#3b82f6;
      --accent-700:#1e63d9;
      --success:#16a34a;
      --danger:#ef4444;
      --radius:10px;
      --shadow-sm:0 6px 18px rgba(9,15,25,0.06);
      --space-xs:8px; --space-sm:12px; --space-md:16px; --space-lg:24px;
      --ease:180ms cubic-bezier(.2,.9,.3,1);
      font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    /* ---------------- Reset ---------------- */
    *{box-sizing:border-box} html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-size:15px}
    a{color:inherit} img{max-width:100%;display:block}
    /* ---------------- Layout ---------------- */
    .app{display:grid;grid-template-columns:260px 1fr;gap:28px;max-width:1200px;margin:28px auto;padding:0 20px}
    @media(max-width:920px){ .app{grid-template-columns:1fr;margin:0;padding:0 12px} .sidebar{display:none} }
    /* ---------------- Sidebar ---------------- */
    .sidebar{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px;box-shadow:var(--shadow-sm);height:calc(100vh - 56px);position:sticky;top:28px;display:flex;flex-direction:column;gap:12px}
    .logo{display:flex;align-items:center;gap:12px}
    .brand-title{font-weight:700;font-size:16px}
    .brand-sub{font-size:12px;color:var(--muted)}
    .nav-section{margin-top:12px;font-size:12px;color:var(--muted);letter-spacing:0.6px}
    .nav-list{display:flex;flex-direction:column;gap:6px;margin-top:6px}
    .nav-item{padding:10px 12px;border-radius:8px;color:var(--muted);cursor:pointer;display:flex;align-items:center;gap:10px;transition:all var(--ease);font-weight:500}
    .nav-item:hover{background:var(--surface-elev);color:var(--text)}
    .nav-item.active{color:var(--accent);background:linear-gradient(90deg, rgba(59,130,246,0.06), rgba(59,130,246,0.02));box-shadow:inset 3px 0 0 var(--accent);font-weight:700}
    .version{margin-top:auto;font-size:12px;color:var(--muted)}
    /* ---------------- Main ---------------- */
    .main{min-height:70vh;padding-bottom:40px}
    .topbar{display:flex;gap:12px;align-items:center;margin-bottom:18px}
    .title{font-size:22px;font-weight:700;margin:0}
    .subtitle{color:var(--muted);font-size:13px}
    .controls{margin-left:auto;display:flex;gap:8px;align-items:center}
    /* ---------------- Cards & grid ---------------- */
    .card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px;box-shadow:var(--shadow-sm)}
    .grid{display:grid;gap:14px}
    .grid-3{grid-template-columns:repeat(3,1fr)}
    @media(max-width:900px){ .grid-3{grid-template-columns:1fr} }
    .metrics-row{display:flex;gap:12px}
    .metric{flex:1;padding:12px;border-radius:10px;display:flex;flex-direction:column;gap:6px}
    .num{font-weight:700;font-size:18px} .label{color:var(--muted);font-size:13px}
    /* ---------------- Tasks ---------------- */
    .two-col{display:grid;grid-template-columns:1fr 360px;gap:20px;margin-top:14px}
    @media(max-width:920px){ .two-col{grid-template-columns:1fr} }
    .tasks-list{display:flex;flex-direction:column;gap:12px;margin-top:10px}
    .task-card{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;padding:12px;border-radius:10px;border:1px solid var(--border);background:var(--surface);transition:transform var(--ease),box-shadow var(--ease)}
    .task-card:hover{transform:translateY(-4px);box-shadow:0 10px 30px rgba(11,18,32,0.06)}
    .task-main{flex:1}
    .task-title{font-weight:600;margin-bottom:6px}
    .task-meta{color:var(--muted);font-size:13px}
    .task-actions{display:flex;gap:8px;align-items:center}
    /* Legacy-friendly classes (common hooks) */
    .task-row{ } .task-item{ } .task-list-container{ }
    /* ---------------- Form ---------------- */
    .form-row{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .lbl{font-size:13px;font-weight:600;color:var(--text)} .hint{font-size:12px;color:var(--muted)}
    .input, textarea, select{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);font-size:14px;background:transparent}
    textarea{min-height:88px;resize:vertical}
    .controls-row{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
    /* ---------------- Matrix ---------------- */
    .matrix-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:14px}
    @media(max-width:768px){ .matrix-grid{grid-template-columns:1fr} }
    .quadrant{min-height:160px;padding:14px;border-radius:10px;border:1px solid var(--border);background:var(--surface);transition:box-shadow var(--ease)}
    .quadrant:hover{box-shadow:0 12px 30px rgba(11,18,32,0.06)}
    .quadrant h3{margin:0 0 8px;font-size:14px}
    .quadrant .quad-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .quad-task{padding:8px;border-radius:8px;border:1px solid var(--border);background:linear-gradient(180deg,#fff,#fcfdff);cursor:grab}
    .quad-task.dragging{opacity:0.5}
    /* ---------------- Focus timer ---------------- */
    .focus{display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center;padding:12px}
    .timer{font-size:32px;font-weight:700}
    /* ---------------- Skeleton & spinner ---------------- */
    .skeleton{background:linear-gradient(90deg,#eef2fb 0%,#f6f8fc 50%,#eef2fb 100%);background-size:200% 100%;animation:pulse 1.6s infinite;border-radius:8px}
    .skeleton.h-40{height:40px}
    @keyframes pulse{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .spinner{border:3px solid #e6eefc;border-top-color:var(--accent);border-radius:50%;width:18px;height:18px;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    /* ---------------- UI kit (toasts, modal, drawer) ---------------- */
    .pb-toasts{position:fixed;top:20px;right:20px;display:flex;flex-direction:column;gap:10px;z-index:9999}
    .pb-toast{min-width:220px;padding:12px 14px;background:var(--surface);border:1px solid var(--border);border-left:4px solid var(--success);border-radius:10px;box-shadow:var(--shadow-sm);display:flex;justify-content:space-between;align-items:center}
    .pb-toast--error{border-left-color:var(--danger)}
    .pb-overlay{position:fixed;inset:0;background:rgba(8,11,20,0.42);display:flex;align-items:center;justify-content:center;z-index:1200}
    .pb-modal{width:720px;max-width:95%;background:var(--surface);border-radius:12px;padding:20px;border:1px solid var(--border);box-shadow:0 20px 50px rgba(3,7,18,0.12)}
    .pb-drawer{position:fixed;right:0;top:0;height:100%;width:480px;max-width:100%;background:var(--surface);box-shadow:-24px 0 48px rgba(3,7,18,0.08);z-index:1200;padding:18px}
    /* ---------------- Buttons ---------------- */
    .btn{display:inline-flex;align-items:center;gap:8px;border-radius:8px;padding:8px 12px;cursor:pointer;border:0;font-weight:600;transition:transform .06s var(--ease)}
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:var(--accent);color:white;box-shadow:0 8px 24px rgba(59,130,246,0.12)}
    .btn-primary:hover{background:var(--accent-700)}
    .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    .btn-small{padding:6px 10px;font-size:13px}
    /* ---------------- Utilities ---------------- */
    .muted{color:var(--muted)} .flex{display:flex} .stack{display:flex;flex-direction:column}
    .ml-auto{margin-left:auto} .sr-only{position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0 0 0 0);white-space:nowrap;border:0;padding:0;margin:-1px}
  </style>
</head>
<body>
  <!-- Toast container -->
  <div class="pb-toasts" id="pbToasts"></div>

  <!-- Mobile header -->
  <div style="display:flex;align-items:center;gap:12px;max-width:1200px;margin:18px auto;padding:0 12px;">
    <div style="display:flex;align-items:center;gap:12px">
      <img src="/images/PrioBox - Icon.png" alt="PrioBox" style="height:40px;width:40px;border-radius:8px;object-fit:contain">
      <div>
        <div class="brand-title">PrioBox</div>
        <div class="muted" style="font-size:12px">Focus what matters</div>
      </div>
    </div>
    <div class="ml-auto" style="display:flex;gap:8px">
      <button class="btn btn-primary btn-small" id="addTaskBtnTop">+ New Task</button>
      <div class="muted" style="align-self:center">Welcome back, Darren</div>
    </div>
  </div>

  <div class="app" role="application" aria-label="PrioBox app shell">
    <!-- Sidebar -->
    <aside class="sidebar" aria-label="Primary navigation">
      <div class="logo">
        <img src="/images/PrioBox - Primary.png" alt="PrioBox">
        <div>
          <div class="brand-title">PrioBox</div>
          <div class="brand-sub">Focus what matters</div>
        </div>
      </div>

      <div class="nav-section">PLAN</div>
      <div class="nav-list" role="navigation" aria-label="Plan">
        <div class="nav-item active" data-route="dashboard" id="nav-dashboard">üè† Dashboard</div>
        <div class="nav-item" data-route="matrix" id="nav-matrix">üóÇ Matrix</div>
      </div>

      <div class="nav-section">DO</div>
      <div class="nav-list" role="navigation" aria-label="Do">
        <div class="nav-item" data-route="focus" id="nav-focus">üî• Focus Mode</div>
      </div>

      <div class="nav-section">TRACK</div>
      <div class="nav-list" role="navigation" aria-label="Track">
        <div class="nav-item" data-route="insights" id="nav-insights">üìä Insights</div>
        <div class="nav-item" data-route="completed" id="nav-completed">‚úÖ Completed</div>
      </div>

      <div class="version">Version: 0.9.1</div>
    </aside>

    <!-- Main -->
    <main class="main" id="mainContent">
      <div class="topbar">
        <div>
          <div class="title">Today's Focus</div>
          <div class="subtitle muted">Your prioritized list & quick actions</div>
        </div>
        <div class="controls">
          <button class="btn btn-ghost btn-small" id="filtersBtn">Filters</button>
          <button class="btn btn-primary btn-small" id="startFocusBtn">Start Focus</button>
        </div>
      </div>

      <!-- Metrics -->
      <section class="card" id="metricsRow">
        <div class="grid grid-3 metrics-row">
          <div class="metric">
            <div class="num" id="dueTodayVal">0</div>
            <div class="label">Tasks due today</div>
          </div>
          <div class="metric">
            <div class="num" id="overdueVal">0</div>
            <div class="label">Overdue</div>
          </div>
          <div class="metric">
            <div class="num" id="completedWeekVal">0</div>
            <div class="label">Completed this week</div>
          </div>
        </div>
      </section>

      <!-- Tasks area + Quick Add -->
      <div class="two-col">
        <!-- LEFT -->
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="muted">Today's Priority Queue ‚Ä¢ Auto-prioritized</div>
            <div class="muted">Cmd/Ctrl+K to quick add</div>
          </div>

          <div class="tasks-list card" id="taskList" aria-live="polite">
            <!-- example placeholder; tasks populated from JS -->
            <div class="task-card task-item" data-id="example-1" role="article" style="display:none">
              <div class="task-main">
                <div class="task-title">Example: Prepare stakeholder update</div>
                <div class="task-meta">Due: Nov 26 ‚Ä¢ Est: 25 min ‚Ä¢ Project: Roadmap</div>
              </div>
              <div class="task-actions">
                <button class="btn btn-primary btn-small task-start" data-action="start">Start</button>
                <button class="btn btn-ghost btn-small task-more" data-action="more">‚Ä¢‚Ä¢‚Ä¢</button>
              </div>
            </div>

            <!-- Loading skeleton (use window.prioShowLoading(true)) -->
            <div id="tasksSkeleton" style="display:none">
              <div class="task-card"><div style="flex:1"><div class="skeleton h-40"></div></div></div>
              <div class="task-card"><div style="flex:1"><div class="skeleton h-40"></div></div></div>
              <div class="task-card"><div style="flex:1"><div class="skeleton h-40"></div></div></div>
            </div>
          </div>

          <!-- Matrix preview -->
          <div class="card" style="margin-top:16px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div style="font-weight:700">Priority Matrix</div>
                <div class="muted" style="font-size:13px">Drag tasks between quadrants to reprioritize</div>
              </div>
              <div>
                <button class="btn btn-ghost btn-small" id="openMatrixBtn">Open Matrix</button>
              </div>
            </div>

            <div class="matrix-grid" id="matrixGrid" style="margin-top:12px">
              <div class="quadrant" data-q="do-first" id="quad-do-first"><h3>Do First</h3><div class="muted">High impact ‚Ä¢ Due soon</div><div class="quad-list"></div></div>
              <div class="quadrant" data-q="schedule" id="quad-schedule"><h3>Schedule</h3><div class="muted">Important ‚Ä¢ Not urgent</div><div class="quad-list"></div></div>
              <div class="quadrant" data-q="delegate" id="quad-delegate"><h3>Delegate</h3><div class="muted">Low impact ‚Ä¢ Urgent</div><div class="quad-list"></div></div>
              <div class="quadrant" data-q="eliminate" id="quad-eliminate"><h3>Eliminate</h3><div class="muted">Low impact ‚Ä¢ Not urgent</div><div class="quad-list"></div></div>
            </div>
          </div>
        </div>

        <!-- RIGHT -->
        <aside>
          <div class="card" id="quickAddCard">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">Quick Add Task</div>
              <div class="muted" style="font-size:13px">Fast capture</div>
            </div>

            <form id="taskForm" class="form-row" onsubmit="return false;" aria-labelledby="taskFormLabel">
              <div>
                <label class="lbl" id="taskFormLabel" for="taskTitle">Title <span class="hint">(required)</span></label>
                <input id="taskTitle" name="title" class="input" placeholder="What needs attention?">
              </div>

              <div>
                <label class="lbl" for="taskDesc">Description <span class="hint">(optional)</span></label>
                <textarea id="taskDesc" name="desc" placeholder="Add helpful notes or acceptance criteria"></textarea>
              </div>

              <div style="display:flex;gap:8px">
                <div style="flex:1">
                  <label class="lbl" for="estTime">Estimate (min)</label>
                  <input id="estTime" name="est" class="input" type="number" min="1" placeholder="25">
                </div>
                <div style="width:140px">
                  <label class="lbl" for="dueDate">Due</label>
                  <input id="dueDate" name="due" class="input" type="date">
                </div>
              </div>

              <div>
                <label class="lbl" for="tagsInput">Tags / Project</label>
                <input id="tagsInput" name="tags" class="input" placeholder="marketing, roadmap">
              </div>

              <div class="controls-row">
                <button class="btn btn-ghost btn-small" id="clearTaskBtn">Clear</button>
                <button class="btn btn-primary btn-small save-btn" id="saveTaskBtn">Add Task</button>
              </div>
            </form>
          </div>

          <div class="card" style="margin-top:12px">
            <div style="font-weight:700">Focus Timer</div>
            <div class="focus" style="margin-top:8px">
              <div class="timer" id="focusTimer">25:00</div>
              <div style="display:flex;gap:8px">
                <button class="btn btn-primary btn-small" id="playFocus">‚ñ∂Ô∏è</button>
                <button class="btn btn-ghost btn-small" id="pauseFocus">‚è∏</button>
                <button class="btn btn-ghost btn-small" id="stopFocus">‚èπ</button>
              </div>
              <div class="muted" style="font-size:13px">Sessions completed: <strong id="sessionsCount">0</strong></div>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <div style="font-weight:700">Weekly Insights</div>
            <div class="muted" style="margin-top:10px">
              <div>Tasks completed this week: <strong id="insCompleted">0</strong></div>
              <div>Average focus session: <strong id="avgFocus">25m</strong></div>
              <div>Top project: <strong id="topProject">‚Äî</strong></div>
            </div>
            <div style="margin-top:12px;display:flex;flex-direction:column;gap:8px">
              <button class="btn btn-primary btn-small" id="exportTasks">Export CSV</button>
              <button class="btn btn-ghost btn-small" id="syncCalendar">Sync with Google Calendar</button>
            </div>
          </div>
        </aside>
      </div>
    </main>
  </div>

  <!-- Inline JS: full client-side functionality + compatibility bridge -->
  <script>
  /**************************************************************************
   * PrioBox Inline JS
   * - TaskStore with LocalStorage driver (can be replaced/swapped)
   * - Renderers for task list and matrix
   * - CRUD: add, edit, delete, complete
   * - Drag & drop between quadrants
   * - Metrics calculation & events (prio:updateMetrics)
   * - Export CSV, calendar sync stub
   * - Focus timer
   * - Compatibility events (prio:saveTask, prio:taskAction, prio:route, etc.)
   **************************************************************************/

  (function(){
    /* ---------------- Utilities ---------------- */
    const uid = (prefix='t') => prefix + Math.random().toString(36).slice(2,9);
    const nowISO = () => new Date().toISOString();
    const parseDate = s => s ? new Date(s) : null;
    const formatDateShort = d => {
      if(!d) return '‚Äî';
      const dt = new Date(d);
      return dt.toLocaleDateString(undefined, { month:'short', day:'numeric' });
    };

    /* ---------------- Storage driver ---------------- */
    class LocalStorageDriver {
      constructor(key='priobox_tasks'){ this.key = key; }
      async list(){ try { const raw = localStorage.getItem(this.key); return raw ? JSON.parse(raw) : []; } catch(e){ console.error(e); return []; } }
      async saveAll(items){ localStorage.setItem(this.key, JSON.stringify(items)); return true; }
    }

    /* ---------------- TaskStore ---------------- */
    class TaskStore {
      constructor(driver){ this.driver = driver; this.tasks = []; }
      async init(){ this.tasks = await this.driver.list(); if(!Array.isArray(this.tasks)) this.tasks = []; return this.tasks; }
      async add(task){ task.id = task.id || uid('t'); task.createdAt = task.createdAt || nowISO(); if(!task.quadrant) task.quadrant = 'do-first'; task.completed = !!task.completed; this.tasks.unshift(task); await this.driver.saveAll(this.tasks); this._emitUpdate(); return task; }
      async update(id, patch){ const i = this.tasks.findIndex(t => t.id === id); if(i===-1) return null; this.tasks[i] = Object.assign({}, this.tasks[i], patch); await this.driver.saveAll(this.tasks); this._emitUpdate(); return this.tasks[i]; }
      async delete(id){ this.tasks = this.tasks.filter(t => t.id !== id); await this.driver.saveAll(this.tasks); this._emitUpdate(); return true; }
      async list(){ return this.tasks.slice(); }
      async find(id){ return this.tasks.find(t => t.id === id) || null; }
      async move(id, quadrant){ const t = await this.find(id); if(!t) return null; t.quadrant = quadrant; await this.update(id, t); return t; }
      async toggleComplete(id){ const t = await this.find(id); if(!t) return null; t.completed = !t.completed; await this.update(id, { completed: t.completed }); return t; }
      _emitUpdate(){
        // emit an internal event for re-renderers
        window.dispatchEvent(new CustomEvent('priobox:storeUpdated', { detail: { count: this.tasks.length } }));
        // also emit prio:updateMetrics (legacy/consumers)
        const metrics = computeMetrics(this.tasks);
        window.dispatchEvent(new CustomEvent('prio:updateMetrics', { detail: metrics }));
      }
    }

    /* ---------------- Metrics computation ---------------- */
    function computeMetrics(tasks){
      const today = new Date(); today.setHours(0,0,0,0);
      let dueToday = 0, overdue = 0, completedWeek = 0;
      const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate() - 7);
      const projectCounts = {};
      tasks.forEach(t => {
        if(t.completed && t.completedAt){
          const ca = new Date(t.completedAt);
          if(ca >= weekAgo) completedWeek++;
        }
        if(t.due){
          const dd = new Date(t.due);
          const dday = new Date(dd.getFullYear(), dd.getMonth(), dd.getDate());
          if(dday.getTime() === today.getTime()) dueToday++;
          if(dday < today && !t.completed) overdue++;
        }
        if(t.tags){
          t.tags.split(',').map(s=>s.trim()).filter(Boolean).forEach(tag => { projectCounts[tag] = (projectCounts[tag]||0)+1; });
        }
      });
      const topProject = Object.keys(projectCounts).sort((a,b)=>projectCounts[b]-projectCounts[a])[0] || null;
      return { dueToday, overdue, completedWeek, topProject };
    }

    /* ---------------- App initialization ---------------- */
    const driver = new LocalStorageDriver('priobox_tasks');
    const store = new TaskStore(driver);

    // DOM hooks
    const els = {
      taskList: document.getElementById('taskList'),
      tasksSkeleton: document.getElementById('tasksSkeleton'),
      taskForm: document.getElementById('taskForm'),
      saveTaskBtn: document.getElementById('saveTaskBtn'),
      clearTaskBtn: document.getElementById('clearTaskBtn'),
      taskTitle: document.getElementById('taskTitle'),
      taskDesc: document.getElementById('taskDesc'),
      estTime: document.getElementById('estTime'),
      dueDate: document.getElementById('dueDate'),
      tagsInput: document.getElementById('tagsInput'),
      quadLists: {
        'do-first': document.querySelector('#quad-do-first .quad-list'),
        'schedule': document.querySelector('#quad-schedule .quad-list'),
        'delegate': document.querySelector('#quad-delegate .quad-list'),
        'eliminate': document.querySelector('#quad-eliminate .quad-list')
      },
      focusTimer: document.getElementById('focusTimer'),
      sessionsCount: document.getElementById('sessionsCount'),
      dueTodayVal: document.getElementById('dueTodayVal'),
      overdueVal: document.getElementById('overdueVal'),
      completedWeekVal: document.getElementById('completedWeekVal'),
      insCompleted: document.getElementById('insCompleted'),
      topProject: document.getElementById('topProject')
    };

    // render helpers
    function renderTaskCard(task){
      const wrapper = document.createElement('div');
      wrapper.className = 'task-card';
      wrapper.setAttribute('draggable','true');
      wrapper.dataset.id = task.id;
      wrapper.innerHTML = `
        <div class="task-main">
          <div class="task-title">${escapeHtml(task.title)}</div>
          <div class="task-meta">${task.completed ? '<strong>Completed</strong> ‚Ä¢ ' : ''}Due: ${task.due ? formatDateShort(task.due) : '‚Äî'} ‚Ä¢ Est: ${task.est || '‚Äî'} min ‚Ä¢ ${task.tags ? escapeHtml(task.tags) : 'No project'}</div>
        </div>
        <div class="task-actions">
          <button class="btn btn-primary btn-small task-start" data-action="start">Start</button>
          <button class="btn btn-ghost btn-small task-edit" data-action="edit">Edit</button>
          <button class="btn btn-ghost btn-small task-delete" data-action="delete">Delete</button>
        </div>
      `;
      // drag events for reordering or dragging to quadrants
      wrapper.addEventListener('dragstart', (ev) => {
        wrapper.classList.add('dragging');
        ev.dataTransfer.setData('text/plain', task.id);
        ev.dataTransfer.effectAllowed = 'move';
      });
      wrapper.addEventListener('dragend', () => wrapper.classList.remove('dragging'));
      return wrapper;
    }

    function escapeHtml(str){
      if(!str) return '';
      return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }

    // render full list and matrix
    async function renderAll(){
      // show skeleton for 200ms to feel responsive
      prioShowLoading(true);
      await new Promise(r => setTimeout(r, 120));
      const tasks = await store.list();
      // render task list (sorted: incomplete first, then by due date)
      els.taskList.innerHTML = '';
      const ordered = tasks.slice().sort((a,b) => {
        if((a.completed?1:0) !== (b.completed?1:0)) return (a.completed?1:0) - (b.completed?1:0);
        const da = a.due ? new Date(a.due).getTime() : 9e15;
        const db = b.due ? new Date(b.due).getTime() : 9e15;
        return da - db;
      });
      ordered.forEach(t => { const node = renderTaskCard(t); els.taskList.appendChild(node); });

      // render quadrants
      for(const q of Object.keys(els.quadLists)) {
        const container = els.quadLists[q];
        container.innerHTML = '';
        tasks.filter(t => (t.quadrant || 'do-first') === q).forEach(t => {
          const li = document.createElement('div');
          li.className = 'quad-task';
          li.draggable = true;
          li.dataset.id = t.id;
          li.innerHTML = `<div style="font-weight:600">${escapeHtml(t.title)}</div><div class="muted" style="font-size:13px">Due: ${t.due ? formatDateShort(t.due) : '‚Äî'}</div>`;
          // drag events
          li.addEventListener('dragstart', (ev)=>{ li.classList.add('dragging'); ev.dataTransfer.setData('text/plain', t.id); ev.dataTransfer.effectAllowed = 'move'; });
          li.addEventListener('dragend', ()=>{ li.classList.remove('dragging'); });
          container.appendChild(li);
        });
      }

      // attach quadrant drop handlers (idempotent)
      Object.keys(els.quadLists).forEach(q => {
        const container = els.quadLists[q];
        ['dragenter','dragover'].forEach(evt => {
          container.addEventListener(evt, (e)=>{ e.preventDefault(); e.dataTransfer.dropEffect = 'move'; container.classList.add('drop-target'); });
        });
        container.addEventListener('dragleave', ()=> container.classList.remove('drop-target'));
        container.addEventListener('drop', async (e) => {
          e.preventDefault(); container.classList.remove('drop-target');
          const id = e.dataTransfer.getData('text/plain');
          if(!id) return;
          await store.move(id, q);
          window.pb.toast('Task moved');
          renderAll();
        });
      });

      prioShowLoading(false);
    }

    /* ---------------- Wire store to UI actions ---------------- */
    // add task from quick-add
    async function handleAddTaskFromForm(){
      const t = (els.taskTitle.value || '').trim();
      if(!t){ window.pb.toast('Please provide a title', { type: 'error' }); return; }
      const newTask = {
        title: t,
        desc: (els.taskDesc.value || '').trim(),
        est: els.estTime.value || '',
        due: els.dueDate.value || '',
        tags: els.tagsInput.value || '',
        quadrant: 'do-first',
        completed: false
      };
      await store.add(newTask);
      // emit legacy and modern events
      window.dispatchEvent(new CustomEvent('prio:saveTask', { detail: newTask }));
      window.dispatchEvent(new CustomEvent('saveTask', { detail: newTask }));
      // clear form
      if(els.taskForm) els.taskForm.reset();
      renderAll();
    }

    // task action delegation (edit/delete/start)
    document.body.addEventListener('click', async (ev) => {
      const actionBtn = ev.target.closest('[data-action], .task-start, .task-edit, .task-delete, .task-more, .task-complete');
      if(!actionBtn) return;
      const taskEl = actionBtn.closest('.task-card, .task-item, .task-row, .quad-task');
      const taskId = taskEl ? (taskEl.dataset.id || taskEl.getAttribute('data-id') || null) : null;
      let action = actionBtn.getAttribute('data-action') || (actionBtn.classList.contains('task-start') ? 'start' : (actionBtn.classList.contains('task-edit') ? 'edit' : (actionBtn.classList.contains('task-delete') ? 'delete' : 'more')));
      // emit generic event
      window.dispatchEvent(new CustomEvent('prio:taskAction', { detail: { action, taskId, origin: actionBtn } }));
      window.dispatchEvent(new CustomEvent('taskAction', { detail: { action, taskId } }));

      if(action === 'delete'){
        if(!taskId) return;
        if(!confirm('Delete this task?')) return;
        await store.delete(taskId);
        window.pb.toast('Task deleted');
        renderAll();
      } else if(action === 'start'){
        // starting focus on a task: set timer and optionally mark something
        const t = await store.find(taskId);
        if(!t) return;
        // For demo, open drawer/modal with details and set focus timer (we simply notify)
        window.pb.openModal(`<div style="font-weight:700;margin-bottom:8px">${escapeHtml(t.title)}</div><div class="muted">${escapeHtml(t.desc||'')}</div><div style="margin-top:12px"><button class="btn btn-primary" id="modalStartFocus">Start Focus</button></div>`);
        document.getElementById('modalStartFocus').addEventListener('click', ()=>{ document.getElementById('playFocus').click(); });
      } else if(action === 'edit'){
        // open drawer with task details for editing
        const t = await store.find(taskId);
        if(!t) return;
        openEditDrawer(t);
      }
    });

    /* ---------------- Edit Drawer ---------------- */
    function openEditDrawer(task){
      const content = document.createElement('div');
      content.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div style="font-weight:700">Edit Task</div>
          <div class="muted">${escapeHtml(task.title)}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:10px">
          <label class="lbl">Title</label>
          <input class="input" id="editTitle" value="${escapeHtml(task.title)}">
          <label class="lbl">Description</label>
          <textarea class="input" id="editDesc">${escapeHtml(task.desc||'')}</textarea>
          <div style="display:flex;gap:8px">
            <div style="flex:1">
              <label class="lbl">Estimate (min)</label>
              <input class="input" id="editEst" value="${escapeHtml(task.est||'')}">
            </div>
            <div style="width:160px">
              <label class="lbl">Due</label>
              <input class="input" id="editDue" type="date" value="${task.due||''}">
            </div>
          </div>
          <label class="lbl">Tags</label>
          <input class="input" id="editTags" value="${escapeHtml(task.tags||'')}">
          <label class="lbl">Quadrant</label>
          <select class="input" id="editQuadrant">
            <option value="do-first"${task.quadrant==='do-first'?' selected':''}>Do First</option>
            <option value="schedule"${task.quadrant==='schedule'?' selected':''}>Schedule</option>
            <option value="delegate"${task.quadrant==='delegate'?' selected':''}>Delegate</option>
            <option value="eliminate"${task.quadrant==='eliminate'?' selected':''}>Eliminate</option>
          </select>
          <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:6px">
            <button class="btn btn-ghost" id="cancelEdit">Cancel</button>
            <button class="btn btn-primary" id="saveEdit">Save</button>
          </div>
        </div>
      `;
      const { overlay, modal } = window.pb.openModal(content.innerHTML);
      // add listeners to modal controls (note: modal recreated so select via DOM)
      modal.querySelector('#cancelEdit').addEventListener('click', ()=> overlay.remove());
      modal.querySelector('#saveEdit').addEventListener('click', async ()=> {
        const patch = {
          title: modal.querySelector('#editTitle').value.trim(),
          desc: modal.querySelector('#editDesc').value.trim(),
          est: modal.querySelector('#editEst').value,
          due: modal.querySelector('#editDue').value,
          tags: modal.querySelector('#editTags').value,
          quadrant: modal.querySelector('#editQuadrant').value
        };
        await store.update(task.id, patch);
        window.pb.toast('Task updated');
        overlay.remove();
        renderAll();
      });
    }

    /* ---------------- Export CSV ---------------- */
    document.getElementById('exportTasks')?.addEventListener('click', async ()=>{
      const rows = await store.list();
      if(!rows.length){ window.pb.toast('No tasks to export', { type:'error' }); return; }
      const csv = [['id','title','desc','est','due','tags','quadrant','completed','createdAt']].concat(rows.map(r => [
        r.id, `"${(r.title||'').replace(/"/g,'""')}"`, `"${(r.desc||'').replace(/"/g,'""')}"`, r.est||'', r.due||'', `"${(r.tags||'').replace(/"/g,'""')}"`, r.quadrant||'', r.completed?1:0, r.createdAt||''
      ])).map(r => r.join(',')).join('\n');
      // download blob
      const blob = new Blob([csv], { type:'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'priobox-tasks.csv'; a.click();
      URL.revokeObjectURL(url);
      window.pb.toast('Exported CSV');
      // emit event for app hooks too
      window.dispatchEvent(new CustomEvent('prio:exportCSV', { detail: { count: rows.length } }));
    });

    /* ---------------- Calendar sync stub ---------------- */
    document.getElementById('syncCalendar')?.addEventListener('click', ()=>{
      // This is a stub. Real calendar sync requires OAuth + calendar API.
      window.pb.toast('Calendar sync: not configured (stub)');
      window.dispatchEvent(new CustomEvent('prio:syncCalendar'));
    });

    /* ---------------- Focus timer (integrates with task start) ---------------- */
    (function(){
      const el = els.focusTimer;
      const sessionsEl = els.sessionsCount;
      let seconds = 25*60, interval = null, sessions = parseInt(localStorage.getItem('priobox_sessions')||'0',10) || 0;
      sessionsEl.textContent = sessions;
      function render(){ el.textContent = String(Math.floor(seconds/60)).padStart(2,'0') + ':' + String(seconds%60).padStart(2,'0') }
      render();
      document.getElementById('playFocus')?.addEventListener('click', ()=> {
        if(interval) return;
        interval = setInterval(()=> {
          if(seconds<=0){ clearInterval(interval); interval=null; sessions++; localStorage.setItem('priobox_sessions', String(sessions)); sessionsEl.textContent = sessions; window.pb.toast('Focus session complete'); seconds = 25*60; render(); return; }
          seconds--; render();
        }, 1000);
      });
      document.getElementById('pauseFocus')?.addEventListener('click', ()=> { if(interval){ clearInterval(interval); interval=null; } });
      document.getElementById('stopFocus')?.addEventListener('click', ()=> { if(interval){ clearInterval(interval); interval=null; } seconds = 25*60; render(); });
    })();

    /* ---------------- prioShowLoading helper (exports to global) ---------------- */
    window.prioShowLoading = function(show){
      const sk = document.getElementById('tasksSkeleton');
      const list = document.getElementById('taskList');
      if(!sk || !list) return;
      if(show){ sk.style.display = 'block'; list.style.opacity = '0.5' } else { sk.style.display = 'none'; list.style.opacity = '1' }
    };

    /* ---------------- Compatibility bridge (events, legacy aliases) ---------------- */
    // Nav clicks
    document.querySelectorAll('.nav-item').forEach(item=>{
      item.addEventListener('click', function(){
        document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
        this.classList.add('active');
        const route = this.getAttribute('data-route') || this.id || this.textContent.toLowerCase();
        window.dispatchEvent(new CustomEvent('prio:route', { detail: { route } }));
      });
    });

    // Save button(s)
    document.querySelectorAll('.save-btn, #saveTaskBtn').forEach(btn => btn.addEventListener('click', handleAddTaskFromForm));
    if(els.taskForm) els.taskForm.addEventListener('submit', (e)=>{ e.preventDefault(); handleAddTaskFromForm(); });

    // Clear button
    document.getElementById('clearTaskBtn')?.addEventListener('click', ()=> { if(els.taskForm) els.taskForm.reset(); window.pb.toast('Cleared'); });

    // Expose debug references
    window._priobox_els = {
      taskList: els.taskList,
      taskForm: els.taskForm,
      quadLists: els.quadLists,
      store: store
    };

    /* ---------------- Initial load ---------------- */
    (async function init(){
      await store.init();
      // If empty, create a tiny sample to show UX
      const all = await store.list();
      if(!all.length){
        await store.add({ title: 'Welcome to PrioBox ‚Äî add your first task', desc: 'Use the Quick Add on the right. Drag tasks into matrix quadrants.', est: '15', due: '', tags: 'onboarding', quadrant: 'do-first' });
      }
      // initial render
      renderAll();
      // emit metrics once ready
      window.dispatchEvent(new CustomEvent('prio:updateMetrics', { detail: computeMetrics(await store.list()) }));
      console.log('PrioBox client initialized (inline JS).');
    })();

    /* ---------------- Helper: open edit via event (external) ---------------- */
    window.addEventListener('prio:openEditTask', async (e) => {
      const id = e.detail && e.detail.id;
      if(!id) return;
      const t = await store.find(id);
      if(t) openEditDrawer(t);
    });

  })();
  </script>
</body>
</html>
